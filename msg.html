<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inderjeet Private Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* WhatsApp Style Background */
        .chat-bg { 
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); 
            background-size: 400px; 
        }
        /* Hide scrollbars but keep scrolling active */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        body { height: 100dvh; overflow: hidden; display: flex; flex-direction: column; background-color: #dadbd3; }
        #chat-box { flex: 1; overflow-y: auto; scroll-behavior: smooth; }
        
        /* Sticky Header */
        header { position: sticky; top: 0; z-index: 100; width: 100%; }
        
        /* Reply Box Styling */
        .reply-bubble { 
            border-left: 4px solid #00a884; 
            background: rgba(0,0,0,0.05); 
            padding: 5px; 
            font-size: 11px; 
            border-radius: 4px; 
            margin-bottom: 5px;
            color: #555;
        }
    </style>
</head>
<body class="font-sans">

    <script>
        // --- APNA GOOGLE SCRIPT URL YAHAN DALEIN ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyGVM4WKi13EhxYYWzSyxsPpbZhKo0JbQ_UaY_nDacAyHShYlvJlvTVmevJeiH2-lOb/exec";
        
        let myName = localStorage.getItem("private_chat_name");
        let selectedReply = null;
        let lastMsgCount = 0;
    </script>

    <div id="login-modal" class="fixed inset-0 bg-[#075e54] z-[200] flex items-center justify-center p-6 hidden">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold text-[#075e54] mb-2 italic">Inderjeet Chat</h2>
            <p class="text-[10px] text-gray-400 mb-6 uppercase tracking-widest font-bold">Sheet Verification Required</p>
            
            <input type="text" id="nameInput" placeholder="Enter Your Name..." 
                   class="w-full p-4 border border-gray-200 rounded-2xl mb-4 text-center font-bold outline-none focus:ring-2 focus:ring-[#075e54]">
            
            <button id="loginBtn" onclick="verifyUser()" class="w-full bg-[#00a884] text-white p-4 rounded-2xl font-bold shadow-lg active:scale-95 transition">
                Start Chatting
            </button>
            
            <p id="errorMsg" class="text-red-500 text-[11px] mt-4 hidden font-bold">Oops! Naam 'Users' sheet mein nahi mila.</p>
        </div>
    </div>

    <div id="main-chat" class="hidden flex-col h-full">
        <header class="bg-[#075e54] text-white p-3 flex justify-between items-center shadow-lg shrink-0">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-gray-200 rounded-full mr-3 overflow-hidden border-2 border-white/20">
                    <img id="header-avatar" src="">
                </div>
                <div>
                    <h1 id="display-name" class="font-bold text-sm italic leading-none"></h1>
                    <span class="text-[10px] text-green-300 font-medium">online</span>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="loadMessages()" class="p-2 bg-white/10 rounded-full active:bg-white/20">ðŸ”„</button>
                <button onclick="logout()" class="p-2 bg-red-500/20 rounded-full border border-red-500/30">ðŸšª</button>
            </div>
        </header>

        <main id="chat-box" class="p-4 chat-bg flex flex-col gap-3 no-scrollbar"></main>

        <div id="reply-preview" class="hidden bg-gray-50 p-2 border-l-4 border-[#00a884] flex justify-between items-center shadow-inner shrink-0">
            <div class="text-xs text-gray-500 truncate italic px-2" id="reply-text"></div>
            <button onclick="cancelReply()" class="text-red-500 font-bold px-3">âœ•</button>
        </div>

        <div class="bg-[#f0f0f0] p-2 flex flex-col gap-2 shrink-0 pb-6 sm:pb-2">
            <div class="flex items-center gap-2">
                <label class="p-2 bg-gray-200 rounded-full cursor-pointer hover:bg-gray-300 transition active:scale-90">
                    <input type="file" id="mediaInput" accept="image/*,video/*" class="hidden" onchange="handleFileUpload(this)">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="#54656f"><path d="M11.5 3a.5.5 0 0 1 .5.5V11h7.5a.5.5 0 0 1 0 1H12v7.5a.5.5 0 0 1-1 0V12H3.5a.5.5 0 0 1 0-1H11V3.5a.5.5 0 0 1 .5-.5z"/></svg>
                </label>
                
                <form id="chat-form" class="flex-1 flex gap-2" onsubmit="sendText(event)">
                    <input type="text" id="userMsg" placeholder="Type a message" 
                           class="flex-1 p-3 px-5 rounded-full outline-none text-sm border border-gray-200 focus:border-[#075e54]">
                    <button type="submit" class="bg-[#00a884] text-white p-3 rounded-full shadow-lg active:scale-90 transition">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M1.101 21.757L23.8 12.028 1.101 2.3l.011 7.912 13.623 1.816-13.623 1.817-.011 7.912z"></path></svg>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const chatBox = document.getElementById('chat-box');
        const inputField = document.getElementById('userMsg');
        const loginModal = document.getElementById('login-modal');
        const mainChat = document.getElementById('main-chat');

        window.onload = () => {
            if (!myName) {
                loginModal.classList.remove('hidden');
            } else {
                startApp();
            }
        };

        // 1. User Verification
        async function verifyUser() {
            const name = document.getElementById('nameInput').value.trim();
            if(!name) return;
            
            document.getElementById('loginBtn').innerText = "Verifying...";
            try {
                const res = await fetch(`${SCRIPT_URL}?action=checkUser&name=${encodeURIComponent(name)}`);
                const data = await res.json();
                
                if(data.allowed) {
                    localStorage.setItem("private_chat_name", name);
                    myName = name;
                    location.reload();
                } else {
                    document.getElementById('errorMsg').classList.remove('hidden');
                    document.getElementById('loginBtn').innerText = "Start Chatting";
                }
            } catch (e) {
                alert("Connection Error! Apna SCRIPT_URL check karein.");
            }
        }

        // 2. Start Application
        function startApp() {
            mainChat.classList.remove('hidden');
            mainChat.classList.add('flex');
            document.getElementById('display-name').innerText = myName;
            document.getElementById('header-avatar').src = `https://ui-avatars.com/api/?name=${myName}&background=random`;
            loadMessages();
            setInterval(loadMessages, 1000); // Super Fast Refresh
        }

        // 3. Drive Link Converter (Links ko Image mein badalne ke liye)
        function fixMediaLink(url, type) {
            if(type === 'image') {
                return url.replace("file/d/", "uc?export=view&id=").split("/view")[0];
            }
            return url.replace("/view", "/preview");
        }

        // 4. Load Messages
        async function loadMessages() {
            try {
                const res = await fetch(`${SCRIPT_URL}?t=${Date.now()}`);
                const data = await res.json();
                
                if(data.length === lastMsgCount) return;

                chatBox.innerHTML = '';
                data.forEach(row => {
                    const [sender, content, time, type, replyTo] = row;
                    const isMe = sender.toLowerCase() === myName.toLowerCase();
                    const timestamp = new Date(time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                    let html = `<div onclick="setReply('${type === 'text' ? content : type}', '${sender}')" 
                                class="${isMe ? 'self-end bg-[#dcf8c6]' : 'self-start bg-white'} max-w-[85%] p-2 rounded-xl shadow-sm cursor-pointer mb-1 relative">`;
                    
                    if (replyTo) html += `<div class="reply-bubble italic text-gray-400 truncate">${replyTo}</div>`;

                    if (type === 'image') {
                        html += `<img src="${fixMediaLink(content, 'image')}" class="rounded-lg max-h-64 w-auto border" onload="chatBox.scrollTop = chatBox.scrollHeight">`;
                    } else if (type === 'video') {
                        html += `<iframe src="${fixMediaLink(content, 'video')}" class="w-full h-48 rounded-lg border"></iframe>`;
                    } else {
                        html += `<p class="text-[14px] text-gray-800 leading-tight">${content}</p>`;
                    }

                    html += `<div class="text-[8px] text-gray-400 text-right mt-1 font-bold">${sender} â€¢ ${timestamp}</div></div>`;
                    chatBox.innerHTML += html;
                });
                
                chatBox.scrollTop = chatBox.scrollHeight;
                lastMsgCount = data.length;
            } catch (e) {}
        }

        // 5. Reply Logic
        function setReply(text, sender) {
            selectedReply = `${sender}: ${text.substring(0, 25)}...`;
            document.getElementById('reply-preview').classList.remove('hidden');
            document.getElementById('reply-text').innerText = "Replying to: " + selectedReply;
            inputField.focus();
        }

        function cancelReply() {
            selectedReply = null;
            document.getElementById('reply-preview').classList.add('hidden');
        }

        // 6. Send Functions
        async function sendText(e) {
            if(e) e.preventDefault();
            const msg = inputField.value.trim();
            if(!msg) return;

            postData(msg, 'text');
            inputField.value = '';
            inputField.focus();
            cancelReply();
        }

        function handleFileUpload(input) {
            const file = input.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            const type = file.type.split('/')[0];
            
            chatBox.innerHTML += `<div class="self-end bg-gray-100 p-2 text-[10px] italic rounded-lg">Uploading ${type}...</div>`;
            chatBox.scrollTop = chatBox.scrollHeight;

            reader.onload = (e) => postData(e.target.result, type);
            reader.readAsDataURL(file);
            input.value = '';
        }

        function postData(content, type) {
            fetch(SCRIPT_URL, {
                method: "POST",
                mode: 'no-cors',
                body: JSON.stringify({ 
                    action: "send", 
                    sender: myName, 
                    message: content, 
                    type: type, 
                    replyTo: selectedReply 
                })
            });
        }

        function logout() {
            if(confirm("Change Name/Logout?")) {
                localStorage.removeItem("private_chat_name");
                location.reload();
            }
        }
    </script>
</body>
</html>
