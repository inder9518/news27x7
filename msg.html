<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inderjeet Private Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chat-bg { background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-size: 400px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        body { height: 100dvh; overflow: hidden; display: flex; flex-direction: column; background-color: #dadbd3; }
        #chat-box { flex: 1; overflow-y: auto; scroll-behavior: auto; }
        header { position: sticky; top: 0; z-index: 100; }
        .reply-bubble { border-left: 4px solid #00a884; background: rgba(0,0,0,0.06); padding: 4px; font-size: 10px; margin-bottom: 4px; border-radius: 4px; }
    </style>
</head>
<body class="font-sans">

    <script>
        // ‚ö†Ô∏è APNA NAYA SCRIPT URL YAHAN DALEIN ‚ö†Ô∏è
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbza00ldStuTpVn9G_COA-mvycm_u6pQ_C0Oa3wL5VI2n4FzIcl81Gix4wKJet0DGHHA/exec";
        
        let myName = localStorage.getItem("p_chat_user");
        let selectedReply = null;
        let lastMsgCount = 0;
    </script>

    <div id="login-modal" class="fixed inset-0 bg-[#075e54] z-[200] flex items-center justify-center p-6 hidden">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold mb-6 italic text-[#075e54]">Inderjeet Chat</h2>
            <input type="text" id="nameInput" placeholder="Apna Naam Likhein..." 
                   class="w-full p-4 border border-gray-200 rounded-2xl mb-4 text-center font-bold outline-none focus:ring-2 focus:ring-[#075e54]">
            <button id="loginBtn" onclick="verifyUser()" class="w-full bg-[#00a884] text-white p-4 rounded-2xl font-bold active:scale-95 transition shadow-lg">Login</button>
            <p id="errorMsg" class="text-red-500 text-xs mt-4 hidden font-bold">Access Denied! Naam Sheet mein nahi hai.</p>
        </div>
    </div>

    <div id="main-chat" class="hidden flex-col h-full">
        <header class="bg-[#075e54] text-white p-3 flex justify-between items-center shadow-lg shrink-0">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-gray-200 rounded-full mr-2 overflow-hidden border">
                    <img id="header-avatar" src="">
                </div>
                <h1 id="display-name" class="font-bold italic text-sm"></h1>
            </div>
            <div class="flex gap-2">
                <button onclick="loadMessages()" class="p-2 bg-white/10 rounded-full active:scale-90 transition">üîÑ</button>
                <button onclick="logout()" class="p-2 bg-red-500/20 rounded-full border border-red-500/20">üö™</button>
            </div>
        </header>

        <main id="chat-box" class="p-4 chat-bg flex flex-col gap-3 no-scrollbar"></main>

        <div id="reply-preview" class="hidden bg-gray-50 p-2 border-l-4 border-[#00a884] flex justify-between items-center shadow-inner">
            <div class="text-[10px] italic truncate px-2 text-gray-500" id="reply-text"></div>
            <button onclick="cancelReply()" class="text-red-500 font-bold px-3">‚úï</button>
        </div>

        <div class="bg-[#f0f0f0] p-2 flex items-center gap-2 pb-6 sm:pb-2 shadow-inner shrink-0">
            <label class="p-2 bg-gray-200 rounded-full cursor-pointer active:scale-90 transition">
                <input type="file" id="mediaInput" accept="image/*,video/*" class="hidden" onchange="handleFileUpload(this)">
                üìé
            </label>
            <form id="chat-form" class="flex-1 flex gap-2" onsubmit="sendText(event)">
                <input type="text" id="userMsg" autocomplete="off" placeholder="Type a message" 
                       class="flex-1 p-3 px-5 rounded-full outline-none text-sm border focus:border-[#075e54]">
                <button type="submit" class="bg-[#00a884] text-white p-3 rounded-full shadow-lg">‚û§</button>
            </form>
        </div>
    </div>

    <script>
        const chatBox = document.getElementById('chat-box');
        const inputField = document.getElementById('userMsg');
        const loginModal = document.getElementById('login-modal');
        const mainChat = document.getElementById('main-chat');

        window.onload = () => {
            if (!myName) loginModal.classList.remove('hidden');
            else startApp();
        };

        async function verifyUser() {
            const name = document.getElementById('nameInput').value.trim();
            if(!name) return;
            document.getElementById('loginBtn').innerText = "Checking...";
            try {
                const res = await fetch(`${SCRIPT_URL}?action=checkUser&name=${encodeURIComponent(name)}`);
                const data = await res.json();
                if(data.allowed) {
                    localStorage.setItem("p_chat_user", name);
                    myName = name;
                    location.reload();
                } else {
                    document.getElementById('errorMsg').classList.remove('hidden');
                    document.getElementById('loginBtn').innerText = "Login";
                }
            } catch (e) {
                alert("Server Error! Kya aapne script deploy karke Everyone ko access di hai?");
            }
        }

        function startApp() {
            mainChat.classList.remove('hidden'); mainChat.classList.add('flex');
            document.getElementById('display-name').innerText = myName;
            document.getElementById('header-avatar').src = `https://ui-avatars.com/api/?name=${myName}&background=random`;
            loadMessages();
            setInterval(loadMessages, 800); // 800ms Fast Refresh
        }

        function fixLink(url, type) {
            if(type === 'image') return url.replace("file/d/", "uc?export=view&id=").split("/view")[0];
            return url.replace("/view", "/preview");
        }

        async function loadMessages() {
            try {
                const res = await fetch(`${SCRIPT_URL}?t=${Date.now()}`);
                const data = await res.json();
                if(data.length === lastMsgCount) return;

                chatBox.innerHTML = '';
                data.forEach(row => {
                    const [sender, content, time, type, replyTo] = row;
                    const isMe = sender.toLowerCase() === myName.toLowerCase();
                    let html = `<div onclick="setReply('${type === 'text' ? content : type}', '${sender}')" class="${isMe ? 'self-end bg-[#dcf8c6]' : 'self-start bg-white'} max-w-[85%] p-1.5 px-2 rounded-xl shadow-sm mb-1 cursor-pointer">`;
                    if (replyTo) html += `<div class="reply-bubble">${replyTo}</div>`;
                    if (type === 'image') {
                        html += `<img src="${fixLink(content, 'image')}" class="rounded-lg max-h-60 border" onload="chatBox.scrollTop = chatBox.scrollHeight">`;
                    } else if (type === 'video') {
                        html += `<iframe src="${fixLink(content, 'video')}" class="w-full h-48 border rounded-lg"></iframe>`;
                    } else {
                        html += `<p class="text-[14px] px-1 text-gray-800">${content}</p>`;
                    }
                    html += `<div class="text-[8px] text-gray-400 text-right mt-1 px-1">${sender} ‚Ä¢ ${new Date(time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div></div>`;
                    chatBox.innerHTML += html;
                });
                chatBox.scrollTop = chatBox.scrollHeight; lastMsgCount = data.length;
            } catch (e) {}
        }

        function setReply(text, sender) {
            selectedReply = `${sender}: ${text.substring(0, 20)}...`;
            document.getElementById('reply-preview').classList.remove('hidden');
            document.getElementById('reply-text').innerText = "Reply to: " + selectedReply;
            inputField.focus();
        }

        function cancelReply() { selectedReply = null; document.getElementById('reply-preview').classList.add('hidden'); }

        async function sendText(e) {
            if(e) e.preventDefault();
            const msg = inputField.value.trim();
            if(!msg) return;
            postData(msg, 'text');
            inputField.value = ''; inputField.focus(); cancelReply();
        }

        function handleFileUpload(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            const type = file.type.split('/')[0];
            const tempId = "up_" + Date.now();
            chatBox.innerHTML += `<div id="${tempId}" class="self-end bg-gray-100 p-2 text-[10px] italic animate-pulse rounded-lg shadow-sm">üöÄ Uploading ${type}...</div>`;
            chatBox.scrollTop = chatBox.scrollHeight;
            reader.onload = (e) => { postData(e.target.result, type).then(() => document.getElementById(tempId).remove()); };
            reader.readAsDataURL(file);
            input.value = '';
        }

        function postData(content, type) {
            return fetch(SCRIPT_URL, {
                method: "POST",
                mode: 'no-cors',
                body: JSON.stringify({ action: "send", sender: myName, message: content, type: type, replyTo: selectedReply })
            });
        }

        function logout() { if(confirm("Naam badalna hai?")) { localStorage.removeItem("p_chat_user"); location.reload(); } }
    </script>
</body>
</html>
